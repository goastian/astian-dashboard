stages:
    - prepare
    - test
    - build

default:
    image: node:15.14.0-stretch
    before_script:
        - npm set cache .npm
        - npm install --prefer-offline --no-audit
    cache:
        key: ${CI_COMMIT_REF_SLUG}
        paths:
            - .npm/
            - node_modules/

install-node-deps:
    stage: prepare
    before_script:
        - node --version
        - npm --version
    script:
        - npm set cache .npm
        - npm ci
    only:
        changes:
            - package*.json

lint:
    stage: test
    script:
        - npm run lint

build-frontend:
    stage: build
    script:
        - npm run build
        - mkdir -p dist/ecloud-dashboard
        - rm dist/js/*.map
        - cp -a appinfo css l10n lib templates dist/css  dist/js dist/ecloud-dashboard
        - cd dist/ && tar -czf ecloud-dashboard.tar.gz ecloud-dashboard

    artifacts:
        paths:
            - dist/ecloud-dashboard.tar.gz
